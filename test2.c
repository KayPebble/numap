/*
 * Copyright 2021 Andrew Kistler
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
 * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR
 * IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <sys/time.h>
#include <windows.h>
#include <numap.h>

// This a the character mapping for the font "Anonymous Pro Minus.ttf" by
// Mark Simonson.
//
static uint16_t numap[] = 
{ 711, 1, 1, 0, 13, 2, 14, 0, 32, 3, 33, 224, 34, 225, 35, 0, 35, 4, 36, 5, 37,
6, 38, 7, 39, 8, 40, 9, 41, 10, 42, 11, 43, 12, 44, 13, 45, 14, 46, 15, 47,
16, 48, 17, 49, 18, 50, 19, 51, 20, 52, 21, 53, 22, 54, 23, 55, 24, 56, 25, 57,
26, 58, 27, 59, 28, 60, 29, 61, 30, 62, 31, 63, 32, 64, 33, 65, 34, 66, 35, 67,
36, 68, 37, 69, 38, 70, 39, 71, 40, 72, 41, 73, 42, 74, 43, 75, 44, 76, 45, 77,
46, 78, 47, 79, 48, 80, 49, 81, 50, 82, 51, 83, 52, 84, 53, 85, 54, 86, 55, 87,
56, 88, 57, 89, 58, 90, 59, 91, 60, 92, 61, 93, 62, 94, 63, 95, 64, 96, 65, 97,
66, 98, 67, 99, 68, 100, 69, 101, 70, 102, 71, 103, 72, 104, 73, 105, 74, 106,
75, 107, 76, 108, 77, 109, 78, 110, 79, 111, 80, 112, 81, 113, 82, 114, 83, 115,
84, 116, 85, 117, 86, 118, 87, 119, 88, 120, 89, 121, 90, 122, 91, 123, 92, 124,
93, 125, 94, 126, 95, 127, 0, 160, 170, 161, 161, 162, 130, 163, 131, 164,
227, 165, 148, 166, 228, 167, 132, 168, 140, 169, 137, 170, 155, 171,
167, 172, 162, 173, 229, 174, 136, 175, 216, 176, 129, 177, 145, 178, 230, 179,
231, 180, 139, 181, 149, 182, 134, 183, 193, 184, 220, 185, 232, 186, 156, 187,
168, 188, 233, 189, 234, 190, 235, 191, 160, 192, 171, 193, 199, 194, 197, 195,
172, 196, 96, 197, 97, 198, 142, 199, 98, 200, 201, 201, 99, 202, 198, 203,
200, 204, 205, 205, 202, 206, 203, 207, 204, 208, 236, 209, 100, 210, 209, 211,
206, 212, 207, 213, 173, 214, 101, 215, 237, 216, 143, 217, 212, 218, 210, 219,
211, 220, 102, 221, 238, 222, 239, 223, 135, 224, 104, 225, 103, 226, 105, 227,
107, 228, 106, 229, 108, 230, 158, 231, 109, 232, 111, 233, 110, 234, 112, 235,
113, 236, 115, 237, 114, 238, 116, 239, 117, 240, 240, 241, 118, 242, 120, 243,
119, 244, 121, 245, 123, 246, 122, 247, 182, 248, 159, 249, 125, 250, 124, 251,
126, 252, 127, 253, 241, 254, 242, 255, 184, 256, 0, 256, 243, 257, 244, 258,
245, 259, 246, 260, 247, 261, 248, 262, 249, 263, 250, 264, 251, 265, 252, 266,
253, 267, 254, 268, 255, 269, 256, 270, 257, 271, 258, 272, 259, 273, 260, 274,
261, 275, 262, 276, 263, 277, 264, 278, 265, 279, 266, 280, 267, 281, 268, 282,
269, 283, 270, 284, 271, 285, 272, 286, 273, 287, 274, 288, 275, 289, 276, 290,
277, 291, 278, 292, 279, 293, 280, 294, 281, 295, 282, 296, 283, 297, 284, 298,
285, 299, 286, 300, 287, 301, 288, 302, 289, 303, 290, 304, 291, 305, 0, 305,
213, 306, 0, 306, 292, 307, 293, 308, 294, 309, 295, 310, 296, 311, 297, 312,
298, 313, 299, 314, 300, 315, 301, 316, 302, 317, 303, 318, 304, 319, 305, 320,
306, 321, 307, 322, 308, 323, 309, 324, 310, 325, 311, 326, 312, 327, 313, 328,
314, 329, 315, 330, 316, 331, 317, 332, 318, 333, 319, 334, 320, 335, 321, 336,
322, 337, 323, 338, 0, 338, 174, 339, 175, 340, 0, 340, 324, 341, 325, 342,
326, 343, 327, 344, 328, 345, 329, 346, 330, 347, 331, 348, 332, 349, 333, 350,
334, 351, 335, 352, 336, 353, 337, 354, 338, 355, 339, 356, 340, 357, 341, 358,
342, 359, 343, 360, 344, 361, 345, 362, 346, 363, 347, 364, 348, 365, 349, 366,
350, 367, 351, 368, 352, 369, 353, 370, 354, 371, 355, 372, 356, 373, 357, 374,
358, 375, 359, 376, 0, 376, 185, 377, 0, 377, 360, 378, 361, 379, 362, 380,
363, 381, 364, 382, 365, 383, 366, 384, 0, 402, 164, 403, 0, 508, 367, 509,
368, 510, 369, 511, 370, 512, 0, 536, 371, 537, 372, 538, 373, 539, 374, 540,
0, 710, 214, 711, 223, 712, 0, 728, 217, 729, 218, 730, 219, 731, 222, 732,
215, 733, 221, 734, 0, 900, 375, 901, 376, 902, 377, 903, 0, 904, 378, 905,
379, 906, 380, 907, 0, 908, 381, 909, 0, 910, 382, 911, 383, 912, 384, 913,
385, 914, 386, 915, 387, 916, 388, 917, 389, 918, 390, 919, 391, 920, 392, 921,
393, 922, 394, 923, 395, 924, 396, 925, 397, 926, 398, 927, 399, 928, 400, 929,
401, 930, 0, 931, 402, 932, 403, 933, 404, 934, 405, 935, 406, 936, 407, 937,
0, 937, 623, 938, 0, 938, 408, 939, 409, 940, 410, 941, 411, 942, 412, 943,
413, 944, 414, 945, 415, 946, 416, 947, 417, 948, 418, 949, 419, 950, 420, 951,
421, 952, 422, 953, 423, 954, 424, 955, 425, 956, 426, 957, 427, 958, 428, 959,
429, 960, 0, 960, 153, 961, 0, 961, 430, 962, 431, 963, 432, 964, 433, 965,
434, 966, 435, 967, 436, 968, 437, 969, 438, 970, 439, 971, 440, 972, 441, 973,
442, 974, 443, 975, 0, 1025, 444, 1026, 445, 1027, 446, 1028, 447, 1029, 
448, 1030, 449, 1031, 450, 1032, 451, 1033, 452, 1034, 453, 1035, 454, 1036,
455, 1037, 0, 1038, 456, 1039, 457, 1040, 458, 1041, 459, 1042, 460, 1043,
461, 1044, 462, 1045, 463, 1046, 464, 1047, 465, 1048, 466, 1049, 467, 1050,
468, 1051, 469, 1052, 470, 1053, 471, 1054, 472, 1055, 473, 1056, 474, 1057,
475, 1058, 476, 1059, 477, 1060, 478, 1061, 479, 1062, 480, 1063, 481, 1064,
482, 1065, 483, 1066, 484, 1067, 485, 1068, 486, 1069, 487, 1070, 488, 1071,
489, 1072, 490, 1073, 491, 1074, 492, 1075, 493, 1076, 494, 1077, 495, 1078,
496, 1079, 497, 1080, 498, 1081, 499, 1082, 500, 1083, 501, 1084, 502, 1085,
503, 1086, 504, 1087, 505, 1088, 506, 1089, 507, 1090, 508, 1091, 509, 1092,
510, 1093, 511, 1094, 512, 1095, 513, 1096, 514, 1097, 515, 1098, 516, 1099,
517, 1100, 518, 1101, 519, 1102, 520, 1103, 521, 1104, 0, 1105, 522, 1106,
523, 1107, 524, 1108, 525, 1109, 526, 1110, 527, 1111, 528, 1112, 529, 1113,
530, 1114, 531, 1115, 532, 1116, 533, 1117, 0, 1118, 534, 1119, 535, 1120,
0, 1168, 536, 1169, 537, 1170, 0, 7682, 538, 7683, 539, 7684, 0, 7690,
540, 7691, 541, 7692, 0, 7710, 542, 7711, 543, 7712, 0, 7744, 544, 7745,
545, 7746, 0, 7766, 546, 7767, 547, 7768, 0, 7776, 548, 7777, 549, 7778,
0, 7786, 550, 7787, 551, 7788, 0, 7808, 552, 7809, 553, 7810, 554, 7811,
555, 7812, 556, 7813, 557, 7814, 0, 7922, 558, 7923, 559, 7924, 0, 8211,
176, 8212, 177, 8213, 560, 8214, 0, 8216, 180, 8217, 181, 8218, 194, 8219,
0, 8220, 178, 8221, 179, 8222, 195, 8223, 0, 8224, 128, 8225, 192, 8226,
133, 8227, 0, 8230, 169, 8231, 0, 8240, 196, 8241, 0, 8249, 188, 8250,
189, 8251, 0, 8260, 186, 8261, 0, 8364, 187, 8365, 0, 8470, 561, 8471, 0, 8482,
138, 8483, 0, 8486, 157, 8487, 0, 8706, 150, 8707, 0, 8710, 166, 8711,
0, 8719, 152, 8720, 0, 8721, 151, 8722, 562, 8723, 0, 8730, 163, 8731,
0, 8734, 144, 8735, 0, 8747, 154, 8748, 0, 8776, 165, 8777, 0, 8800,
141, 8801, 0, 8804, 146, 8805, 147, 8806, 0, 8963, 563, 8964, 0, 8984,
564, 8985, 0, 8996, 565, 8997, 566, 8998, 567, 8999, 0, 9085, 568, 9086,
0, 9096, 569, 9097, 0, 9166, 570, 9167, 0, 9251, 571, 9252, 0, 9472,
572, 9473, 0, 9474, 573, 9475, 0, 9484, 574, 9485, 0, 9488, 575, 9489,
0, 9492, 576, 9493, 0, 9496, 577, 9497, 0, 9500, 578, 9501, 0, 9508, 579, 9509,
0, 9516, 580, 9517, 0, 9524, 581, 9525, 0, 9532, 582, 9533, 0, 9552,
583, 9553, 584, 9554, 585, 9555, 586, 9556, 587, 9557, 588, 9558, 589, 9559,
590, 9560, 591, 9561, 592, 9562, 593, 9563, 594, 9564, 595, 9565, 596, 9566,
597, 9567, 598, 9568, 599, 9569, 600, 9570, 601, 9571, 602, 9572, 603, 9573,
604, 9574, 605, 9575, 606, 9576, 607, 9577, 608, 9578, 609, 9579, 610, 9580,
611, 9581, 0, 9670, 612, 9671, 0, 9674, 183, 9675, 0, 10003, 613, 10004,
0, 57344, 614, 57345, 615, 57346, 616, 57347, 617, 57348, 618, 57349,
619, 57350, 620, 57351, 621, 57352, 0, 63171, 226, 63172, 0, 63743, 208, 63744,
622, 63745, 0, 64257, 190, 64258, 191, 64259, 0 };

static inline uint16_t cmap1(uint16_t c)
{
  return numap_map16(numap, c);
}

static inline uint16_t cmap2(uint16_t c)
{
  uint16_t o = 0;
  uint16_t temp;
  static uint8_t* buf = NULL;
  if (NULL == buf) {
    uintptr_t _pagesize;
    DWORD permissions;
    DWORD out_permissions;
    SYSTEM_INFO system_info;

    GetSystemInfo(&system_info);

    _pagesize = (uintptr_t)system_info.dwPageSize;
    buf = (uint8_t*)malloc(numap_compile16(numap, NULL, NULL));
    permissions = 0x40;
    if (!VirtualProtect(buf, _pagesize, permissions, &out_permissions)) {
      fprintf(stderr,"VirtualProtect(%p,%d,%d,%p):", buf, _pagesize, permissions, &out_permissions);
      return 0;
    }
    numap_compile16(numap, buf, (void*)&&reentry);
  }
  __asm__(
    "jmp *%[buf];"
    :
    : [ input ] "ax" ( c ),
      [ temp ] "dx" ( temp ),
      [ output ] "ebx" ( &o ),
      [ buf ] "m" ( buf )
    : "ecx"
  );
reentry:
  return o;
}

#define NSAMPLES 16384

int main(int argc, char** argv)
{
  int i;
  uint16_t arr[NSAMPLES];
  time_t t;
  uint16_t o;
  LARGE_INTEGER StartingTime, EndingTime, ElapsedMicroseconds;
  LARGE_INTEGER Frequency;


  if (argc == 2) {
    uint16_t c;
    sscanf(argv[1], "%d", &c);
    printf("->%d\n", cmap1(c));
    printf("->%d\n", cmap2(c));
    return 0;
  }

  srand((unsigned)time(&t));

  for (i = 0; i < NSAMPLES; i++) {
    arr[i] = rand();
  }


  QueryPerformanceFrequency(&Frequency);
  QueryPerformanceCounter(&StartingTime);

  for (i = 0; i < NSAMPLES; i++) {
    o = cmap1(arr[i]);
  }

  QueryPerformanceCounter(&EndingTime);

  ElapsedMicroseconds.QuadPart = EndingTime.QuadPart - StartingTime.QuadPart;
  ElapsedMicroseconds.QuadPart *= 1000000;
  ElapsedMicroseconds.QuadPart /= Frequency.QuadPart;

  printf("[1] %lu us", ElapsedMicroseconds.QuadPart);
  printf(" / %d\n", NSAMPLES);


  QueryPerformanceCounter(&StartingTime);

  for (i = 0; i < NSAMPLES; i++) {
    o = cmap2(arr[i]);
  }

  QueryPerformanceCounter(&EndingTime);

  ElapsedMicroseconds.QuadPart = EndingTime.QuadPart - StartingTime.QuadPart;
  ElapsedMicroseconds.QuadPart *= 1000000;
  ElapsedMicroseconds.QuadPart /= Frequency.QuadPart;

  printf("[2] %lu us", ElapsedMicroseconds.QuadPart);
  printf(" / %d\n", NSAMPLES);

  return 0;
}
